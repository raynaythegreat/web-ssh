<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0d1117" />
    <title>Web Terminal</title>

    <!-- xterm.js dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css" />
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://unpkg.com/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <script src="https://unpkg.com/socket.io@4.8.1/client-dist/socket.io.min.js"></script>

    <style>
      :root {
        --bg-primary: #0d1117;
        --bg-secondary: #161b22;
        --bg-tertiary: #21262d;
        --border-color: #30363d;
        --text-primary: #e6edf3;
        --text-secondary: #8b949e;
        --accent-green: #3fb950;
        --accent-red: #f85149;
        --accent-blue: #58a6ff;
        --accent-yellow: #d29922;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100%;
        overflow: hidden;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
      }

      body {
        display: flex;
        flex-direction: column;
      }

      .header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 8px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        z-index: 10;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .connection-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .connection-badge.connected {
        background: rgba(63, 185, 80, 0.15);
        border-color: var(--accent-green);
        color: var(--accent-green);
      }

      .connection-badge.disconnected {
        background: rgba(248, 81, 73, 0.15);
        border-color: var(--accent-red);
        color: var(--accent-red);
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
      }

      #terminal-container {
        flex-grow: 1;
        width: 100%;
        background: #000;
        padding: 8px;
        overflow: hidden;
      }

      .xterm {
        padding: 4px;
      }

      .btn-logout {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
      }

      .btn-logout:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <div class="logo">WEB-SSH</div>
        <div id="status-badge" class="connection-badge disconnected">
          <span class="dot"></span>
          <span id="status-text">Disconnected</span>
        </div>
      </div>
      <button class="btn-logout" onclick="logout()">Logout</button>
    </header>

    <div id="terminal-container"></div>

    <script>
      const token = localStorage.getItem('ssh_token');
      if (!token) {
        window.location.href = '/login.html';
      }

      const statusBadge = document.getElementById('status-badge');
      const statusText = document.getElementById('status-text');

      // Initialize Xterm
      const term = new Terminal({
        cursorBlink: true,
        fontFamily: '"Cascadia Code", Menlo, Monaco, "Courier New", monospace',
        fontSize: 14,
        theme: {
          background: '#000000',
          foreground: '#d1d1d1',
          cursor: '#58a6ff',
          selectionBackground: 'rgba(88, 166, 255, 0.3)',
          black: '#000000',
          red: '#f85149',
          green: '#3fb950',
          yellow: '#d29922',
          blue: '#58a6ff',
          magenta: '#bc8cff',
          cyan: '#39c5cf',
          white: '#d1d1d1'
        },
        allowTransparency: true
      });

      const fitAddon = new FitAddon.FitAddon();
      const webLinksAddon = new WebLinksAddon.WebLinksAddon();
      term.loadAddon(fitAddon);
      term.loadAddon(webLinksAddon);

      term.open(document.getElementById('terminal-container'));
      fitAddon.fit();
      term.focus();

      // Socket.io Connection
      const socket = io({
        auth: { token },
        transports: ['websocket']
      });

      socket.on('connect', () => {
        statusBadge.className = 'connection-badge connected';
        statusText.innerText = 'Connected';
        
        // Start terminal on server with current dimensions
        const dims = { cols: term.cols, rows: term.rows };
        socket.emit('terminal:start', dims);
      });

      socket.on('disconnect', () => {
        statusBadge.className = 'connection-badge disconnected';
        statusText.innerText = 'Disconnected';
        term.write('\r\n\x1b[31mConnection lost. Refresh to reconnect.\x1b[0m\r\n');
      });

      socket.on('connect_error', (err) => {
        if (err.message === 'xhr poll error') return;
        console.error('Connection error:', err);
        logout();
      });

      // Data handling
      term.onData(data => socket.emit('terminal:input', data));
      socket.on('terminal:output', data => term.write(data));
      
      socket.on('terminal:exit', () => {
        term.write('\r\n\x1b[33mSession ended.\x1b[0m\r\n');
        statusBadge.className = 'connection-badge disconnected';
        statusText.innerText = 'Closed';
      });

      // Window resize handling
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          fitAddon.fit();
          socket.emit('terminal:resize', {
            cols: term.cols,
            rows: term.rows
          });
        }, 100);
      });

      function logout() {
        localStorage.removeItem('ssh_token');
        window.location.href = '/login.html';
      }

      // Initial fit after a short delay to ensure layout is ready
      setTimeout(() => fitAddon.fit(), 500);
    </script>
  </body>
</html>