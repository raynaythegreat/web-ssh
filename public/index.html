<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Web Terminal</title>

    <!-- xterm.js for better terminal emulation -->
    <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css" />
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        background: #1e1e1e;
        color: #fff;
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace;
        touch-action: manipulation;
        -webkit-text-size-adjust: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header {
        background: #2a2a2a;
        padding: 8px;
        text-align: center;
        font-size: 12px;
        color: #0f0;
        border-bottom: 1px solid #444;
        flex-shrink: 0;
      }

      .terminal-container {
        flex: 1;
        padding: 10px;
        background: #000;
        position: relative;
      }

      #terminal {
        width: 100%;
        height: 100%;
        font-size: 11px;
      }

      .status {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: #0f0;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        z-index: 10;
      }

      .status.disconnected {
        color: #ff6b6b;
      }

      .input-area {
        background: #2a2a2a;
        padding: 8px;
        border-top: 1px solid #444;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }

      .mobile-keyboard-toggle {
        background: #007aff;
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        -webkit-tap-highlight-color: transparent;
      }

      .clear-btn {
        background: #ff3b30;
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        -webkit-tap-highlight-color: transparent;
      }

      .logout-btn {
        background: #666;
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        -webkit-tap-highlight-color: transparent;
      }

      /* Mobile keyboard fix */
      .keyboard-input {
        position: fixed;
        bottom: -100px;
        left: 0;
        width: 1px;
        height: 1px;
        opacity: 0;
        pointer-events: none;
      }

      .keyboard-input.show {
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 40px;
        opacity: 1;
        pointer-events: auto;
        background: #333;
        border: 1px solid #555;
        color: #fff;
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
      }

      @media (max-width: 480px) {
        .header {
          font-size: 11px;
          padding: 6px;
        }
        .terminal-container {
          padding: 5px;
        }
        #terminal {
          font-size: 10px;
        }
        .input-area {
          padding: 6px;
          gap: 6px;
        }
        .mobile-keyboard-toggle,
        .clear-btn {
          padding: 6px 10px;
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">üì± SSH Terminal ‚Ä¢ doughstackr@100.115.92.206 ‚Ä¢ <span id="status">Connecting...</span></div>

    <div class="terminal-container">
      <div class="status" id="connection-status">üîÑ Connecting...</div>
      <div id="terminal"></div>
    </div>

    <div class="input-area">
      <button class="mobile-keyboard-toggle" onclick="toggleKeyboard()">‚å®Ô∏è Keyboard</button>
      <button class="clear-btn" onclick="clearTerminal()">üóëÔ∏è Clear</button>
      <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    </div>

    <input type="text" class="keyboard-input" id="mobile-keyboard" placeholder="Type here..." />

    <script>
      const terminal = new Terminal({
        cursorBlink: true,
        theme: {
          background: "#000000",
          foreground: "#ffffff",
          cursor: "#ffffff",
          selection: "#ffffff40",
          black: "#000000",
          red: "#ff0000",
          green: "#00ff00",
          yellow: "#ffff00",
          blue: "#0000ff",
          magenta: "#ff00ff",
          cyan: "#00ffff",
          white: "#ffffff",
          brightBlack: "#808080",
          brightRed: "#ff8080",
          brightGreen: "#80ff80",
          brightYellow: "#ffff80",
          brightBlue: "#8080ff",
          brightMagenta: "#ff80ff",
          brightCyan: "#80ffff",
          brightWhite: "#ffffff",
        },
      })

      const fit = new FitAddon.FitAddon()
      terminal.loadAddon(fit)

      terminal.open(document.getElementById("terminal"))
      fit.fit()

      let sessionId = null
      let isPolling = false

      // Start SSH session
      async function startSSH() {
        try {
          const response = await fetch("/start-ssh", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          })

          const data = await response.json()
          sessionId = data.sessionId
          terminal.write(data.output)
          updateStatus("Connected")

          // Start polling for output
          pollOutput()
        } catch (error) {
          terminal.write("\\r\\n‚ùå Connection failed: " + error.message + "\\r\\n")
          updateStatus("Disconnected")
        }
      }

      // Poll for output (since we can't use WebSockets on Vercel)
      function pollOutput() {
        if (isPolling) return
        isPolling = true

        const poll = async () => {
          try {
            const response = await fetch("/get-output")
            const data = await response.json()

            if (data.output) {
              terminal.write(data.output)
            }

            if (data.connected === false) {
              updateStatus("Disconnected")
              isPolling = false
              return
            }

            // Continue polling
            setTimeout(poll, 200)
          } catch (error) {
            console.error("Poll error:", error)
            setTimeout(poll, 1000)
          }
        }

        poll()
      }

      // Handle terminal input
      terminal.onData((data) => {
        sendInput(data)
      })

      async function sendInput(input) {
        try {
          await fetch("/send-input", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input }),
          })
        } catch (error) {
          console.error("Send input error:", error)
        }
      }

      // Handle mobile keyboard
      const mobileKeyboard = document.getElementById("mobile-keyboard")

      function toggleKeyboard() {
        mobileKeyboard.classList.toggle("show")
        if (mobileKeyboard.classList.contains("show")) {
          mobileKeyboard.focus()
        }
      }

      mobileKeyboard.addEventListener("input", (e) => {
        const text = e.target.value
        if (text) {
          sendInput(text)
          e.target.value = ""
        }
      })

      mobileKeyboard.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          sendInput("\\r")
          e.target.value = ""
        } else if (e.key === "Backspace") {
          sendInput("\\u007F")
        }
      })

      function clearTerminal() {
        terminal.clear()
      }

      async function logout() {
        const token = localStorage.getItem("terminal-token") || sessionStorage.getItem("terminal-token")

        if (token) {
          try {
            await fetch("/logout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token }),
            })
          } catch (error) {
            console.error("Logout error:", error)
          }
        }

        // Clear local storage
        localStorage.removeItem("terminal-token")
        localStorage.removeItem("terminal-token-expiry")
        sessionStorage.removeItem("terminal-token")

        // Redirect to login
        window.location.href = "/"
      }

      function updateStatus(status) {
        document.getElementById("status").textContent = status
        const statusElement = document.getElementById("connection-status")

        if (status === "Connected") {
          statusElement.textContent = "üü¢ Connected"
          statusElement.className = "status"
        } else {
          statusElement.textContent = "üî¥ Disconnected"
          statusElement.className = "status disconnected"
        }
      }

      // Handle window resize
      window.addEventListener("resize", () => {
        fit.fit()
      })

      // Check authentication
      function checkAuth() {
        const urlParams = new URLSearchParams(window.location.search)
        const token =
          urlParams.get("token") || sessionStorage.getItem("terminal-token") || localStorage.getItem("terminal-token")

        if (!token) {
          window.location.href = "/"
          return false
        }

        // Add token to all requests
        const originalFetch = window.fetch
        window.fetch = function (...args) {
          if (args[1]) {
            args[1].headers = {
              ...args[1].headers,
              Authorization: token,
            }
          } else {
            args[1] = {
              headers: {
                Authorization: token,
              },
            }
          }
          return originalFetch.apply(this, args)
        }

        return true
      }

      // Start SSH connection on load (after auth check)
      if (checkAuth()) {
        startSSH()
      }

      // Focus terminal for desktop
      terminal.focus()
    </script>
  </body>
</html>
